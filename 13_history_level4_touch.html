<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¬¬2è¯¾ï¼šå››çº§ç»“æ„ç‰©ç§äº¤æ¢å›¾è°± (è§¦æ§ç‰ˆ)</title>
    <style>
        /* --- åŸºç¡€è®¾ç½® --- */
        body { 
            margin: 0; overflow: hidden; 
            background-color: #080a10; /* æ·±ç©º */
            font-family: "Microsoft YaHei", sans-serif; 
            user-select: none; /* ç¦æ­¢é€‰ä¸­æ–‡æœ¬ */
            touch-action: none; /* ç¦æ­¢æµè§ˆå™¨é»˜è®¤æ»šåŠ¨ */
        }
        
        canvas { display: block; cursor: grab; }
        canvas:active { cursor: grabbing; }

        /* --- UI è¦†ç›–å±‚ --- */
        .ui-layer {
            position: absolute; top: 30px; left: 30px;
            color: #fff; pointer-events: none; z-index: 10;
        }
        h1 { 
            margin: 0; text-shadow: 0 0 20px #00d2ff; 
            font-size: 36px; font-weight: 900;
        }
        .subtitle { font-size: 20px; color: #aaa; margin-top: 10px; }
        
        /* å›¾ä¾‹ */
        .legend { margin-top: 20px; font-size: 18px; display: flex; gap: 20px; }
        .dot { width: 16px; height: 16px; border-radius: 50%; display: inline-block; margin-right: 8px; vertical-align: middle; }

        /* --- ä¾§è¾¹è¯¦æƒ…æ  (è§¦æ§ä¼˜åŒ–ç‰ˆ) --- */
        .sidebar {
            position: absolute; top: 0; right: 0; bottom: 0;
            width: 500px; /* åŠ å®½ï¼Œé€‚åº”è§¦æ‘¸ */
            max-width: 90%;
            background: rgba(20, 28, 40, 0.96);
            backdrop-filter: blur(20px);
            border-left: 2px solid rgba(255,255,255,0.2);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            padding: 40px; 
            box-sizing: border-box;
            color: #eee; z-index: 100;
            box-shadow: -20px 0 50px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
        }
        .sidebar.active { transform: translateX(0); }

        /* å·¨å‹å…³é—­æŒ‰é’® */
        .close-btn {
            position: absolute; top: 20px; right: 30px;
            width: 60px; height: 60px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 40px; cursor: pointer; color: #fff;
            transition: 0.2s;
        }
        .close-btn:active { background: #c0392b; transform: scale(0.9); }

        /* å†…å®¹æ ·å¼ (å¤§å­—ä½“) */
        .card-header {
            margin-top: 40px;
            font-size: 36px; font-weight: 900; 
            border-bottom: 4px solid; padding-bottom: 20px; margin-bottom: 30px;
            line-height: 1.2;
        }
        
        .tag-row { margin-bottom: 20px; }
        .tag {
            display: inline-block; padding: 8px 16px; border-radius: 8px;
            font-size: 18px; margin-right: 10px; color: #000; font-weight: bold;
        }

        .card-content {
            font-size: 24px; /* æ­£æ–‡å¤§å­— */
            line-height: 1.8; color: #b0b8c4; text-align: justify;
            flex: 1; overflow-y: auto;
        }

        /* å²æ–™å¡ç‰‡æ ·å¼ */
        .source-box {
            background: #fff8e1; color: #5d4037;
            padding: 20px; border-radius: 10px;
            border-left: 8px solid #ffb300;
            margin-top: 30px;
        }
        .source-text { font-family: "KaiTi", serif; font-size: 26px; font-weight: bold; }
        .source-ref { margin-top: 10px; text-align: right; font-size: 20px; opacity: 0.8; }

    </style>
</head>
<body>

    <div class="ui-layer">
        <h1>ğŸŒŒ å“¥ä¼¦å¸ƒå¤§äº¤æ¢</h1>
        <div class="subtitle">å››çº§ç»“æ„çŸ¥è¯†å›¾è°± (è§¦æ§ç‰ˆ)</div>
        <div class="legend">
            <div><span class="dot" style="background:#e67e22"></span>ç¾æ´²å¤–ä¼ </div>
            <div><span class="dot" style="background:#3498db"></span>ä¼ å…¥ç¾æ´²</div>
            <div><span class="dot" style="background:#27ae60"></span>å…¨çƒå½±å“</div>
        </div>
    </div>

    <canvas id="world"></canvas>

    <div class="sidebar" id="sidebar">
        <div class="close-btn" onclick="closeSidebar()">Ã—</div>
        <div id="sidebar-content">
            <div class="card-header" id="d-title">æ ‡é¢˜</div>
            <div class="tag-row" id="d-tags"></div>
            <div class="card-content" id="d-desc">å†…å®¹</div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. å››çº§çŸ¥è¯†æ•°æ®ç»“æ„ (L1->L2->L3->L4)
        // ==========================================
        
        const nodes = [
            // --- Level 1: æ ¸å¿ƒ (Root) ---
            { id: 0, text: "å…¨çƒç‰©ç§\nå¤§äº¤æ¢", group: "root", level: 1, size: 50, x: 0, y: 0, z: 0, desc: "æ–°èˆªè·¯å¼€è¾Ÿåï¼Œå»ºç«‹åœ¨æ¬§æ´²ã€äºšæ´²ã€éæ´²å’Œç¾æ´²ä¹‹é—´çš„å…¨çƒæ€§ç”Ÿç‰©è”ç³»ã€‚" },

            // ==========================================
            // åˆ†æ”¯ä¸€ï¼šç¾æ´²å¤–ä¼  (Orange)
            // ==========================================
            // Level 2: æ–¹å‘
            { id: 100, text: "ç¾æ´²å¤–ä¼ ", group: "out", level: 2, size: 35, x: -150, y: 0, z: 0, desc: "ç¾æ´²ç‰¹æœ‰çš„é«˜äº§ä½œç‰©å‘ä¸–ç•Œä¼ æ’­ã€‚" },
            
            // Level 3: ç±»åˆ«
            { id: 110, text: "ç²®é£Ÿä½œç‰©", group: "out", level: 3, size: 25, x: -250, y: 100, z: 50, desc: "ç‰ç±³ã€é©¬é“ƒè–¯ã€ç”˜è–¯æ˜¯ç¾æ´²ä¸‰å¤§é«˜äº§æ”¯æŸ±ã€‚" },
            { id: 120, text: "ç»æµ/è”¬æœ", group: "out", level: 3, size: 25, x: -250, y: -100, z: -50, desc: "æ”¹å˜äº†ä¸–ç•Œçš„é¥®é£Ÿå£å‘³å’Œç»æµç»“æ„ã€‚" },

            // Level 4: å…·ä½“ç‰©ç§ä¸äº‹ä»¶ (è§¦æ§é‡ç‚¹)
            { id: 111, text: "ç‰ç±³", group: "out", level: 4, size: 18, x: -350, y: 150, z: 80, 
              desc: "äº§é‡æé«˜ï¼Œè€å¯’è€æ—±ã€‚åœ¨æ¸…æœå¤§è§„æ¨¡ç§æ¤äºæ·±å±±ã€‚", 
              quote: "ç§å‡ºè¥¿åœŸï¼Œç§è€…äº¦ç½•ã€‚å…¶è‹—å¶ä¿±ä¼¼èœ€é»è€Œè‚¥çŸ®ã€‚", source: "ææ—¶çã€Šæœ¬è‰çº²ç›®ã€‹" },
            
            { id: 112, text: "ç•ªè–¯", group: "out", level: 4, size: 18, x: -380, y: 80, z: 20, 
              desc: "æ•‘è’ç¬¬ä¸€åŠŸè‡£ã€‚ä¸‡å†å¹´é—´ä¼ å…¥ä¸­å›½ã€‚", 
              quote: "å¤§æœ‰æ”¶è·ï¼Œå¯å……è°·é£Ÿä¹‹åŠã€‚", source: "ã€Šé—½ä¹¦ã€‹" },
            
            { id: 113, text: "é™ˆæŒ¯é¾™", group: "out", level: 4, size: 22, x: -420, y: 40, z: 40, 
              desc: "<b>ã€å…³é”®äººç‰©ã€‘</b>ç¦å»ºå•†äººã€‚åœ¨è²å¾‹å®¾å†’æ­»å°†ç•ªè–¯è—¤ç¼–å…¥ç¼†ç»³å¸¦å›ä¸­å›½ï¼Œè¢«èª‰ä¸ºâ€œç”˜è–¯ä¹‹çˆ¶â€ã€‚" },

            { id: 121, text: "è¾£æ¤’", group: "out", level: 4, size: 18, x: -350, y: -150, z: -80, 
              desc: "æ˜ä»£ä¼ å…¥æ—¶ç§°â€œç•ªæ¤’â€ï¼Œåˆä¸ºè§‚èµã€‚åå½»åº•æ”¹å˜äº†è¥¿å—åœ°åŒºçš„é¥®é£Ÿã€‚", 
              quote: "å‘³è¾£ï¼Œè‰²çº¢ï¼Œç”šå¯è§‚ã€‚", source: "é«˜æ¿‚ã€Šéµç”Ÿå…«ç¬ºã€‹" },

            // ==========================================
            // åˆ†æ”¯äºŒï¼šä¼ å…¥ç¾æ´² (Blue)
            // ==========================================
            // Level 2: æ–¹å‘
            { id: 200, text: "ä¼ å…¥ç¾æ´²", group: "in", level: 2, size: 35, x: 150, y: 0, z: 0, desc: "æ¬§äºšç‰©ç§é‡å¡‘äº†ç¾æ´²çš„ç”Ÿæ€ä¸ç»æµã€‚" },

            // Level 3: ç±»åˆ«
            { id: 210, text: "å¤§å‹åŠ¨ç‰©", group: "in", level: 3, size: 25, x: 250, y: 80, z: -40, desc: "ç¾æ´²åŸæœ¬ç¼ºä¹å¤§å‹å®¶ç•œï¼Œå¼•å…¥åæå¤§æå‡äº†ç”Ÿäº§åŠ›ã€‚" },
            { id: 220, text: "ç§æ¤å›­ä½œç‰©", group: "in", level: 3, size: 25, x: 250, y: -80, z: 60, desc: "æœåŠ¡äºæ¬§æ´²å¸‚åœºçš„ç»æµä½œç‰©ã€‚" },

            // Level 4: å…·ä½“ç‰©ç§ä¸äº‹ä»¶
            { id: 211, text: "é©¬", group: "in", level: 4, size: 20, x: 350, y: 120, z: -60, 
              desc: "<b>â€œå¤§å¾æœè€…â€</b>ã€‚å½»åº•æ”¹å˜äº†å°ç¬¬å®‰äººçš„æˆ˜äº‰å’Œç‹©çŒæ–¹å¼ï¼Œä½†ä¹Ÿå¸¦æ¥äº†å†›äº‹å¾æœçš„ä¸å¯¹ç­‰ã€‚" },
            
            { id: 221, text: "å°éº¦", group: "in", level: 4, size: 18, x: 350, y: -50, z: 80, 
              desc: "æ¬§æ´²æ®–æ°‘è€…ä¸ºäº†åƒç™½é¢åŒ…å’Œå®—æ•™åœ£é¤ï¼Œå¼ºè¡Œåœ¨ç¾æ´²æ¨å¹¿ã€‚" },
            
            { id: 222, text: "ç”˜è”—", group: "in", level: 4, size: 20, x: 380, y: -120, z: 100, 
              desc: "å“¥ä¼¦å¸ƒå¸¦å…¥ã€‚ç”˜è”—ç§æ¤å›­ç»æµä¸ä»…æ å¤ºäº†åœŸåœ°ï¼Œè¿˜ç›´æ¥å‚¬ç”Ÿäº†å¥´éš¶è´¸æ˜“ã€‚",
              quote: "å¦‚æœå“¥ä¼¦å¸ƒå¸¦æ¥çš„ç‰ç±³æ˜¯èµç¦ï¼Œé‚£ç”˜è”—ä¾¿æ˜¯ä¸ªè¯…å’’ã€‚", source: "ã€ŠèˆŒå°–ä¸Šçš„å†å²ã€‹" },

            { id: 231, text: "å¤©èŠ±/ç—…èŒ", group: "in", level: 4, size: 18, x: 320, y: 0, z: 0, 
              desc: "çœ‹ä¸è§çš„æ€æ‰‹ã€‚åŸä½æ°‘ç¼ºä¹å…ç–«åŠ›ï¼Œäººå£é”å‡90%ä»¥ä¸Šã€‚" },

            // ==========================================
            // åˆ†æ”¯ä¸‰ï¼šå…¨çƒå½±å“ (Green)
            // ==========================================
            // Level 2: æ–¹å‘
            { id: 300, text: "æ·±è¿œå½±å“", group: "impact", level: 2, size: 35, x: 0, y: 200, z: 0, desc: "è¾©è¯åˆ†æï¼šæœºé‡ä¸æŒ‘æˆ˜å¹¶å­˜ã€‚" },

            // Level 3: ç±»åˆ«
            { id: 310, text: "ç¤¾ä¼šåæœ", group: "impact", level: 3, size: 25, x: -80, y: 300, z: 50, desc: "äººå£ä¸ç¤¾ä¼šç»“æ„çš„å˜è¿ã€‚" },
            { id: 320, text: "ç”Ÿæ€åæœ", group: "impact", level: 3, size: 25, x: 80, y: 300, z: -50, desc: "ç¯å¢ƒä¸è‡ªç„¶ç•Œçš„å˜åŒ–ã€‚" },

            // Level 4: å…·ä½“äº‹ä»¶
            { id: 311, text: "äººå£æ¿€å¢", group: "impact", level: 4, size: 20, x: -120, y: 380, z: 80, 
              desc: "é«˜äº§ä½œç‰©å…»æ´»äº†æ›´å¤šäººã€‚æ”¯æ’‘äº†æ¸…æœâ€œåº·ä¹¾ç››ä¸–â€äººå£çªç ´3äº¿ã€‚",
              quote: "æå¤§åœ°å¢åŠ äº†ç²®é£Ÿäº§é‡ï¼Œå¹¶å…»æ´»äº†è¶Šæ¥è¶Šå¤šçš„äººã€‚", source: "å¼ ç®­ã€Šæ–°å¤§é™†å†œä½œç‰©ã€‹" },

            { id: 312, text: "å¥´éš¶è´¸æ˜“", group: "impact", level: 4, size: 20, x: -60, y: 350, z: 120, 
              desc: "ä¸‰è§’è´¸æ˜“ã€‚ä¸ºäº†ç§æ¤ç”˜è”—å’Œæ£‰èŠ±ï¼Œåƒä¸‡éæ´²é»‘å¥´è¢«è´©å–è‡³ç¾æ´²ã€‚" },

            { id: 321, text: "æ°´åœŸæµå¤±", group: "impact", level: 4, size: 20, x: 100, y: 380, z: -80, 
              desc: "æ¸…æœåæœŸï¼Œä¸ºäº†å…»æ´»äººå£è¿‡åº¦å¼€å¦å±±æ—ï¼Œå¯¼è‡´ç”Ÿæ€ç¾éš¾ã€‚",
              quote: "æ·±æ—å‰ªä¼æ®†å°½ï¼Œå·¨é˜œå±å³°ï¼Œä¸€æœ›çš†åŒ…è°·ä¹Ÿã€‚", source: "ã€Šå»ºå§‹å¿å¿—ã€‹" }
        ];

        // è¿çº¿å…³ç³» (åŒ…å«å­ç›®é—´å…³ç³»)
        const links = [
            // L1 -> L2
            [0, 100], [0, 200], [0, 300],
            
            // L2 -> L3
            [100, 110], [100, 120],
            [200, 210], [200, 220],
            [300, 310], [300, 320],

            // L3 -> L4 (å…·ä½“)
            [110, 111], [110, 112], 
            [112, 113], // ç•ªè–¯ -> é™ˆæŒ¯é¾™
            [120, 121], 
            [210, 211], 
            [220, 221], [220, 222], 
            [200, 231], // ä¼ å…¥ç¾æ´² -> ç—…èŒ
            [310, 311], [310, 312], 
            [320, 321],

            // *** å­ç›®é—´å…³ç³» (Cross Links) ***
            [222, 312], // ç”˜è”—(L4) -> å¥´éš¶è´¸æ˜“(L4) (å› æœ)
            [111, 311], // ç‰ç±³(L4) -> äººå£æ¿€å¢(L4) (å› æœ)
            [111, 321]  // ç‰ç±³(L4) -> æ°´åœŸæµå¤±(L4) (å› æœ)
        ];

        // é¢œè‰²é…ç½®
        const colors = {
            "root": "#ffffff",
            "out": "#e67e22",   // æ©™è‰²
            "in": "#3498db",    // è“è‰²
            "impact": "#27ae60" // ç»¿è‰²
        };

        // ==========================================
        // 2. åŸç”Ÿ 3D å¼•æ“ (è§¦æ§å¢å¼ºç‰ˆ)
        // ==========================================
        const canvas = document.getElementById('world');
        const ctx = canvas.getContext('2d');
        
        let width, height;
        let rotation = { x: 0, y: 0 };
        let targetRotation = { x: 0, y: 0 };
        let zoom = 0.6; // åˆå§‹è§†è§’æ‹‰è¿œï¼Œçœ‹æ¸…å…¨è²Œ
        
        // è§¦æ§å˜é‡
        let isDragging = false;
        let lastX = 0, lastY = 0;
        let initialPinchDistance = null;
        let initialZoom = zoom;

        const fov = 1000;

        // åˆå§‹åŒ–
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- è§¦æ§/é¼ æ ‡ äº‹ä»¶å¤„ç† ---
        
        // 1. å¼€å§‹äº¤äº’
        function onStart(x, y) {
            isDragging = true;
            lastX = x;
            lastY = y;
        }

        canvas.addEventListener('mousedown', e => onStart(e.clientX, e.clientY));
        canvas.addEventListener('touchstart', e => {
            if (e.touches.length === 1) {
                onStart(e.touches[0].clientX, e.touches[0].clientY);
            } else if (e.touches.length === 2) {
                // åŒæŒ‡ç¼©æ”¾é€»è¾‘
                isDragging = false;
                initialPinchDistance = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                initialZoom = zoom;
            }
        });

        // 2. ç§»åŠ¨äº¤äº’
        function onMove(x, y) {
            if (!isDragging) return;
            const dx = x - lastX;
            const dy = y - lastY;
            targetRotation.y += dx * 0.004; // çµæ•åº¦è°ƒæ•´
            targetRotation.x += dy * 0.004;
            lastX = x;
            lastY = y;
        }

        window.addEventListener('mousemove', e => onMove(e.clientX, e.clientY));
        window.addEventListener('touchmove', e => {
            if (e.touches.length === 1) {
                onMove(e.touches[0].clientX, e.touches[0].clientY);
            } else if (e.touches.length === 2 && initialPinchDistance) {
                // åŒæŒ‡ç¼©æ”¾
                const currentDist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                zoom = initialZoom * (currentDist / initialPinchDistance);
                zoom = Math.min(Math.max(0.2, zoom), 3);
            }
        });

        // 3. ç»“æŸäº¤äº’
        window.addEventListener('mouseup', () => isDragging = false);
        window.addEventListener('touchend', () => {
            isDragging = false;
            initialPinchDistance = null;
        });
        
        // é¼ æ ‡æ»šè½®
        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            zoom += e.deltaY * -0.001;
            zoom = Math.min(Math.max(0.2, zoom), 3);
        });

        // ç‚¹å‡»æ£€æµ‹ (å¢åŠ è§¦æ‘¸å®¹é”™èŒƒå›´)
        canvas.addEventListener('click', handleClick);
        // ä¸ºäº†å…¼å®¹è§¦æ‘¸ç‚¹å‡»ï¼Œç®€å•çš„touchendæ¨¡æ‹Ÿclickç•¥å¤æ‚ï¼Œè¿™é‡Œä¾èµ–ç³»ç»Ÿè‡ªåŠ¨è§¦å‘çš„click

        function handleClick(e) {
            if (isDragging) return;
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            let clickedNode = null;
            projectedNodes.sort((a, b) => b.scale - a.scale).forEach(p => {
                if (clickedNode) return;
                // è§¦æ‘¸å±å¢åŠ ç‚¹å‡»åŠå¾„ (+20px)
                const dist = Math.hypot(p.x2d - mouseX, p.y2d - mouseY);
                if (dist < p.radius + 20) { 
                    clickedNode = p.node;
                }
            });

            if (clickedNode) showSidebar(clickedNode);
            else closeSidebar();
        }

        // èŠ‚ç‚¹ç¼“å­˜
        let projectedNodes = [];

        // æ¸²æŸ“å¾ªç¯
        function loop() {
            rotation.x += (targetRotation.x - rotation.x) * 0.1;
            rotation.y += (targetRotation.y - rotation.y) * 0.1;
            
            // è‡ªåŠ¨å¾®æ—‹è½¬ (å±•ç¤ºæ•ˆæœ)
            if (!isDragging && !initialPinchDistance) {
                targetRotation.y += 0.0005;
            }

            ctx.fillStyle = '#080a10';
            ctx.fillRect(0, 0, width, height);

            // 1. æŠ•å½±
            projectedNodes = nodes.map(node => {
                let x = node.x, y = node.y, z = node.z;
                let tx = x * Math.cos(rotation.y) - z * Math.sin(rotation.y);
                let tz = x * Math.sin(rotation.y) + z * Math.cos(rotation.y);
                x = tx; z = tz;
                let ty = y * Math.cos(rotation.x) - z * Math.sin(rotation.x);
                tz = y * Math.sin(rotation.x) + z * Math.cos(rotation.x);
                y = ty; z = tz;

                const scale = fov / (fov + z) * zoom;
                const x2d = x * scale + width / 2;
                const y2d = y * scale + height / 2;

                return { node, x2d, y2d, scale, zIndex: z, radius: node.size * scale * 0.5 };
            });

            // 2. ç»˜åˆ¶è¿çº¿
            ctx.lineWidth = 2; // çº¿æ¡åŠ ç²—ï¼Œé€‚åˆå¤§å±
            links.forEach(link => {
                const start = projectedNodes.find(p => p.node.id === link[0]);
                const end = projectedNodes.find(p => p.node.id === link[1]);
                if (start && end) {
                    ctx.beginPath();
                    ctx.moveTo(start.x2d, start.y2d);
                    ctx.lineTo(end.x2d, end.y2d);
                    
                    // é€»è¾‘å…³è”çº¿ç”¨è™šçº¿ (ID > 100 çš„èŠ‚ç‚¹é—´)
                    if (link[0] > 100 && link[1] > 100 && Math.abs(link[0]-link[1]) > 50) {
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                        ctx.setLineDash([10, 10]); // è™šçº¿
                    } else {
                        // å¸¸è§„å±‚çº§çº¿
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
                        ctx.setLineDash([]);
                    }
                    ctx.stroke();
                }
            });
            ctx.setLineDash([]);

            // 3. ç»˜åˆ¶èŠ‚ç‚¹
            projectedNodes.sort((a, b) => b.zIndex - a.zIndex);

            projectedNodes.forEach(p => {
                const color = colors[p.node.group];
                
                // å…‰æ™•
                const gradient = ctx.createRadialGradient(p.x2d, p.y2d, p.radius * 0.2, p.x2d, p.y2d, p.radius * 2.5);
                gradient.addColorStop(0, color);
                gradient.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(p.x2d, p.y2d, p.radius * 2.5, 0, Math.PI * 2);
                ctx.fill();

                // å®ä½“çƒ
                ctx.fillStyle = "#fff";
                ctx.beginPath();
                ctx.arc(p.x2d, p.y2d, p.radius * 0.4, 0, Math.PI * 2);
                ctx.fill();

                // æ–‡å­— (åŠ å¤§å­—å·)
                // Level 4 çš„å­—ä½“ç¨å¾®å°ä¸€ç‚¹ç‚¹
                const fontSize = p.node.level === 4 ? 10 : 14;
                ctx.font = `bold ${fontSize * p.scale}px "Microsoft YaHei"`;
                ctx.fillStyle = "#fff";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.shadowColor = "black";
                ctx.shadowBlur = 5;
                
                // è‡ªåŠ¨æ¢è¡Œ
                const lines = p.node.text.split('\n');
                lines.forEach((line, i) => {
                    const yOffset = (i - (lines.length-1)/2) * (fontSize + 4) * p.scale;
                    ctx.fillText(line, p.x2d, p.y2d + p.radius + 15 * p.scale + yOffset);
                });
                ctx.shadowBlur = 0;
            });

            requestAnimationFrame(loop);
        }

        // --- ä¾§è¾¹æ é€»è¾‘ ---
        const sidebar = document.getElementById('sidebar');
        const dTitle = document.getElementById('d-title');
        const dTags = document.getElementById('d-tags');
        const dDesc = document.getElementById('d-desc');

        function showSidebar(node) {
            sidebar.classList.add('active');
            
            // æ ‡é¢˜é¢œè‰²
            dTitle.innerHTML = node.text.replace('\n', ' ');
            const c = colors[node.group];
            dTitle.style.borderColor = c;
            dTitle.style.color = c;

            // æ ‡ç­¾ç”Ÿæˆ
            let tagsHtml = "";
            if(node.group === "out") tagsHtml += `<span class="tag" style="background:#e67e22">ç¾æ´²å¤–ä¼ </span>`;
            if(node.group === "in") tagsHtml += `<span class="tag" style="background:#3498db">ä¼ å…¥ç¾æ´²</span>`;
            if(node.group === "impact") tagsHtml += `<span class="tag" style="background:#27ae60">å…¨çƒå½±å“</span>`;
            if(node.level === 4) tagsHtml += `<span class="tag" style="background:#fff">å…·ä½“å²å®</span>`;
            
            dTags.innerHTML = tagsHtml;

            // å†…å®¹ + å²æ–™
            let contentHtml = node.desc;
            if(node.quote) {
                contentHtml += `
                    <div class="source-box">
                        <div class="source-text">â€œ${node.quote}â€</div>
                        <div class="source-ref">â€”â€” ${node.source}</div>
                    </div>
                `;
            }
            dDesc.innerHTML = contentHtml;
        }

        function closeSidebar() {
            sidebar.classList.remove('active');
        }

        loop();

    </script>
</body>
</html>